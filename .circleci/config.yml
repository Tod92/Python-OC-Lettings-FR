# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1


orbs:
  aws-ecr: circleci/aws-ecr@8.1.3

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/configuration-reference/#jobs
jobs:
  test-and-lint:
    docker:
      - image: cimg/python:3.10.1
    steps:
      - checkout
      - run:
          name: install dependencies
          command: pip install -r requirements.txt
      - run:
          name: lint
          command: flake8
      - run:
          name: run tests
          command: pytest
  aws-ecr/build-and-push-image:

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/configuration-reference/#workflows
workflows:
  build-and-test-workflow:
    jobs:
      - test-and-lint
  build_and_push_image:
    jobs:
      - aws-ecr/build-and-push-image:
        requires:
          - test-and-lint
        filters:
          branches:
            only:
              - master
        context: aws-dev
        create-repo: true
        dockerfile: Dockerfile
        path: .
        repo: circleci-ecr-demo
        tag: "$CIRCLE_SHA1"